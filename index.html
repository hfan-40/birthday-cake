<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>The Eternal Golden Wish - V13 Masterpiece</title>
    <link rel="icon" href="data:,">
    <style>
        @import url('https://gs.jurieo.com/gemini/fonts-googleapis/css2?family=Cinzel:wght@700&display=swap');
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Cinzel', serif; }
        #canvas-container { width: 100vw; height: 100vh; position: absolute; }
        #video-input { 
            position: absolute; top: 25px; left: 25px; width: 140px; height: 105px; 
            transform: scaleX(-1); opacity: 0.15; border: 1px solid rgba(255, 215, 0, 0.5); 
            border-radius: 15px; z-index: 5; transition: opacity 0.5s;
        }
        #video-input:hover { opacity: 0.6; }
        #ui-layer { position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%); z-index: 10; text-align: center; pointer-events: none; width: 100%; }
        .upload-btn { 
            pointer-events: auto; background: linear-gradient(135deg, #ffd700, #b8860b); color: #000; 
            padding: 15px 45px; font-weight: 800; cursor: pointer; border-radius: 50px; border: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); letter-spacing: 3px; font-family: 'Cinzel', serif;
            transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .upload-btn:hover { transform: scale(1.1) translateY(-5px); box-shadow: 0 15px 40px rgba(255, 215, 0, 0.4); }
        #loading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; color: #ffd700; z-index: 100; display: flex; justify-content: center; align-items: center; background: #000; flex-direction: column; }
        #gesture-hint { font-size: 20px; margin-top: 30px; color: #ffd700; text-shadow: 0 0 15px #ff8c00; letter-spacing: 4px; font-weight: bold; }
    </style>
    <script type="importmap">
    {
        "imports": {
            "three": "https://esm.sh/three@0.160.0",
            "three/addons/": "https://esm.sh/three@0.160.0/examples/jsm/",
            "@mediapipe/tasks-vision": "https://esm.sh/@mediapipe/tasks-vision@0.10.8",
            "@tweenjs/tween.js": "https://esm.sh/@tweenjs/tween.js@23.1.1"
        }
    }
    </script>
</head>
<body>
    <div id="loading">
        <div style="font-size: 36px; letter-spacing: 10px; font-weight: 900;">GOLDEN ETERNITY</div>
        <div id="status" style="font-size: 14px; margin-top: 15px; opacity: 0.6; letter-spacing: 2px;">Harmonizing Light & Vision...</div>
    </div>
    <video id="video-input" autoplay playsinline></video>
    <div id="canvas-container"></div>
    <div id="ui-layer">
        <button class="upload-btn" onclick="document.getElementById('file-input').click()">UPLOAD MEMORIES</button>
        <div id="gesture-hint">Waiting for the spark...</div>
    </div>
    <input type="file" id="file-input" multiple accept="image/*">

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { FilesetResolver, HandLandmarker, FaceLandmarker } from '@mediapipe/tasks-vision';
        import TWEEN from '@tweenjs/tween.js';

        const PARTICLE_COUNT = 7500;
        let scene, camera, renderer, composer, controls, pMesh, dummy;
        let particles = [], textPoints = [], photoPlanes = [], photos = [];
        let handAI, faceAI, video, lastAiTime = 0, frameCount = 0;
        let state = 'assembled', isLock = false, isLit = true;

        async function init() {
            setupThree();
            await createParticles();
            await setupAI();
            setupVideo();
            setupEvents();
            document.getElementById('loading').style.display = 'none';
            animate();
        }

        function setupThree() {
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.018); // Â¢ûÂä†ËÉåÊôØÊ∑±Â∫¶

            camera = new THREE.PerspectiveCamera(38, window.innerWidth/window.innerHeight, 1, 1000);
            camera.position.set(0, 15, 48);

            renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.6; // ÊòæËëóÊèêÈ´òÊõùÂÖâÂ¢ûÂº∫ÈáëÁ¢ßËæâÁÖåÊÑü
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            const bloom = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.2, 0.4, 0.8);
            bloom.threshold = 0.18; bloom.strength = 1.3; bloom.radius = 0.5;

            composer = new EffectComposer(renderer);
            composer.addPass(new RenderPass(scene, camera));
            composer.addPass(bloom);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true; controls.autoRotate = true; controls.autoRotateSpeed = 0.6;

            const wick = new THREE.PointLight(0xffaa00, 18, 55);
            wick.position.set(0, 7.5, 0); wick.name = "wick"; scene.add(wick);
            scene.add(new THREE.AmbientLight(0xffffff, 0.35));
        }

        async function createParticles() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 1000; canvas.height = 200;
            ctx.font = 'bold 84px "Cinzel"';
            ctx.fillStyle = 'white';
            ctx.textAlign = 'center';
            ctx.fillText("HAPPY BIRTHDAY", 500, 115);
            const data = ctx.getImageData(0, 0, 1000, 200).data;
            for(let y=0; y<200; y+=3) { // Êõ¥ÂØÜÈõÜÁöÑÈááÊ†∑
                for(let x=0; x<1000; x+=3) {
                    if(data[(y*1000+x)*4+3] > 128) {
                        // Â¢ûÂä†ÂéöÂ∫¶ÊÑüÔºåÂàõÂª∫ÊµÆÈõïÊïàÊûú
                        const zOffset = (Math.random() - 0.5) * 0.8;
                        textPoints.push(new THREE.Vector3((x-500)*0.12, (100-y)*0.12 + 6, zOffset));
                    }
                }
            }

            const mat = new THREE.MeshPhongMaterial({ 
                color: 0xffd700, emissive: 0x332200, shininess: 120 
            });
            pMesh = new THREE.InstancedMesh(new THREE.SphereGeometry(0.13, 6, 6), mat, PARTICLE_COUNT);
            dummy = new THREE.Object3D();

            for(let i=0; i<PARTICLE_COUNT; i++) {
                let cPos, sPos, tPos, color, isFlame = false, fHeight = 0;
                if (i < PARTICLE_COUNT * 0.55) { // ËõãÁ≥ï‰∏ãÂ±Ç
                    const r = 4.5 + Math.random()*2, a = Math.random()*Math.PI*2, h = (Math.random()-0.5)*5;
                    cPos = new THREE.Vector3(r*Math.cos(a), h, r*Math.sin(a));
                    color = new THREE.Color(0xffd700);
                } else if (i < PARTICLE_COUNT * 0.88) { // ËõãÁ≥ï‰∏äÂ±Ç
                    const r = Math.random()*3.5, a = Math.random()*Math.PI*2, h = Math.random()*3.8 + 2.8;
                    cPos = new THREE.Vector3(r*Math.cos(a), h, r*Math.sin(a));
                    color = new THREE.Color(0xff69b4).lerp(new THREE.Color(0xffd700), 0.3);
                } else { // Áé∞ÂÆû‰∏ª‰πâÁÅ´ÁÑ∞
                    fHeight = Math.random();
                    const h = fHeight * 3.2 + 6.2;
                    const r = (1.0 - fHeight) * 0.45;
                    const a = Math.random()*Math.PI*2;
                    cPos = new THREE.Vector3(r*Math.cos(a), h, r*Math.sin(a));
                    // ÁÅ´ÁÑ∞Ëâ≤Ê∏©Ê¢ØÂ∫¶
                    color = fHeight < 0.2 ? new THREE.Color(0xccffff) : (fHeight < 0.7 ? new THREE.Color(0xffaa00) : new THREE.Color(0xff3300));
                    isFlame = true;
                }
                sPos = new THREE.Vector3((Math.random()-0.5)*65, (Math.random()-0.5)*55, (Math.random()-0.5)*65);
                tPos = (i < textPoints.length) ? textPoints[i].clone() : sPos.clone();

                particles.push({ curr: cPos.clone(), cake: cPos, scatter: sPos, text: tPos, isFlame, fHeight, seed: Math.random()*100 });
                dummy.position.copy(cPos); dummy.updateMatrix();
                pMesh.setMatrixAt(i, dummy.matrix);
                pMesh.setColorAt(i, color);
            }
            scene.add(pMesh);

            for(let i=0; i<5; i++) {
                const mesh = new THREE.Mesh(new THREE.PlaneGeometry(10, 6.5), new THREE.MeshBasicMaterial({ transparent: true, opacity: 0, side: THREE.DoubleSide }));
                mesh.userData = { home: new THREE.Vector3((Math.random()-0.5)*40, (Math.random()-0.5)*35, (Math.random()-0.5)*20) };
                mesh.position.copy(mesh.userData.home);
                scene.add(mesh); photoPlanes.push(mesh);
            }
        }

        function transformTo(ns) {
            if (isLock || state === ns) return;
            isLock = true; state = ns;
            const dur = ns === 'scattered' ? 900 : 2000;
            const wick = scene.getObjectByName("wick");

            if (ns === 'assembled') {
                isLit = true; new TWEEN.Tween(wick).to({intensity: 18}, 1000).start(); 
                controls.autoRotate = true;
                document.getElementById('gesture-hint').innerText = "BLOW üòó OR PINCH ‚úã";
            } else {
                isLit = false; new TWEEN.Tween(wick).to({intensity: 0.1}, 500).start();
                controls.autoRotate = false;
                if(ns === 'text') new TWEEN.Tween(scene.rotation).to({y: 0}, 1500).start();
                document.getElementById('gesture-hint').innerText = ns === 'text' ? "‚ú® WISH GRANTED ‚ú®" : "FRAGMENTS OF MEMORY";
            }

            particles.forEach((p, i) => {
                const target = ns === 'assembled' ? p.cake : (ns === 'text' ? p.text : p.scatter);
                new TWEEN.Tween(p.curr).to({x: target.x, y: target.y, z: target.z}, dur + Math.random()*700)
                    .easing(ns === 'scattered' ? TWEEN.Easing.Back.Out : TWEEN.Easing.Exponential.InOut)
                    .start();
                if(p.isFlame) {
                    const c = ns === 'assembled' ? (p.fHeight < 0.2 ? 0xccffff : (p.fHeight < 0.7 ? 0xffaa00 : 0xff3300)) : 0x110500;
                    pMesh.setColorAt(i, new THREE.Color(c));
                }
            });
            pMesh.instanceColor.needsUpdate = true;
            
            photoPlanes.forEach(m => {
                new TWEEN.Tween(m.material).to({opacity: (ns === 'scattered' && photos.length > 0) ? 1 : 0}, 1000).start();
            });
            setTimeout(() => { isLock = false; }, dur + 500);
        }

        async function setupAI() {
            const vis = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.8/wasm");
            handAI = await HandLandmarker.createFromOptions(vis, {
                baseOptions: { modelAssetPath: `https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task`, delegate: "GPU" },
                runningMode: "VIDEO", numHands: 1
            });
            faceAI = await FaceLandmarker.createFromOptions(vis, {
                baseOptions: { modelAssetPath: `https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task`, delegate: "GPU" },
                outputFaceBlendshapes: true, runningMode: "VIDEO", numFaces: 1
            });
        }

        function predict() {
            const now = performance.now();
            if (now - lastAiTime > 180 && !isLock) { // Èôç‰ΩéAIÈ¢ëÁéá‰ª•ÊèêÂçá‰∏ªÁ∫øÁ®ãÊµÅÁïÖÂ∫¶
                lastAiTime = now;
                const hRes = handAI.detectForVideo(video, now);
                if (hRes.landmarks.length > 0) {
                    const l = hRes.landmarks[0];
                    const d = Math.hypot(l[8].x-l[0].x, l[8].y-l[0].y);
                    if (d > 0.45 && state === 'assembled') transformTo('scattered');
                    if (d < 0.2 && state !== 'assembled') transformTo('assembled');
                }
                const fRes = faceAI.detectForVideo(video, now);
                if (fRes.faceBlendshapes.length > 0) {
                    const s = fRes.faceBlendshapes[0].categories.find(c => c.categoryName === 'mouthPucker').score;
                    if (s > 0.65 && state === 'assembled') transformTo('text');
                }
            }
            requestAnimationFrame(predict);
        }

        function setupVideo() {
            video = document.getElementById('video-input');
            navigator.mediaDevices.getUserMedia({ video: true }).then(s => {
                video.srcObject = s; video.onloadeddata = () => predict();
            });
        }

        function setupEvents() {
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
                composer.setSize(window.innerWidth, window.innerHeight);
            });
            document.getElementById('file-input').onchange = (e) => {
                const loader = new THREE.TextureLoader();
                for(let i=0; i<Math.min(e.target.files.length, 5); i++) {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        const tex = loader.load(ev.target.result);
                        tex.colorSpace = THREE.SRGBColorSpace;
                        photos[i] = tex; photoPlanes[i].material.map = tex; photoPlanes[i].material.needsUpdate = true;
                    };
                    reader.readAsDataURL(e.target.files[i]);
                }
            };
        }

        function animate() {
            requestAnimationFrame(animate);
            TWEEN.update(); controls.update();
            frameCount++;
            const t = Date.now() * 0.0018;

            // ÂàÜÂ∏ßÊõ¥Êñ∞ÔºåÂπ≥Ë°° 55ms ÁöÑ Violation Ë≠¶Âëä
            const start = (frameCount % 2) * (PARTICLE_COUNT / 2);
            const end = start + (PARTICLE_COUNT / 2);

            for(let i=0; i<PARTICLE_COUNT; i++) {
                const p = particles[i];
                if (i >= start && i < end || p.isFlame || state === 'text') {
                    if (p.isFlame && isLit && state === 'assembled') {
                        // ÊãüÁúüÁ©∫Ê∞îÁÉ≠ÂØπÊµÅÊäñÂä®
                        const drift = Math.sin(t * 8 + p.seed) * (p.fHeight * 0.3);
                        const lift = Math.sin(t * 15 + p.seed) * 0.08;
                        dummy.position.set(p.curr.x + drift, p.curr.y + lift, p.curr.z + drift);
                    } else if (state === 'text' && i < textPoints.length) {
                        // ÊñáÂ≠óÊÄÅÂæÆÂº±ÂëºÂê∏ÊÑüÔºå‰øùÊåÅÁ®≥ÂÆö‰∏ç‰∏¢Â§±Â±ïÁ§∫
                        const vib = Math.sin(t * 3 + i) * 0.015;
                        dummy.position.set(p.curr.x + vib, p.curr.y + vib, p.curr.z + vib);
                    } else {
                        dummy.position.copy(p.curr);
                    }
                    dummy.updateMatrix();
                    pMesh.setMatrixAt(i, dummy.matrix);
                }
            }
            pMesh.instanceMatrix.needsUpdate = true;
            if (isLit) scene.getObjectByName("wick").intensity = 18 + Math.sin(t*15)*3;
            composer.render();
        }

        init();
    </script>
</body>
</html>
